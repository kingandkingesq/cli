#!/usr/bin/env bash
source $(cli loader)
cli::import cli_assert

help() {
cat << EOF
Command
    ${CLI_COMMAND}
    
Summary
    Read stdin into an associative array.

Description
    Reads an even number of lines from a file to populate an associative
    array. Even lines are keys and odd lines are values. The associative
    array must be declared before calling readmap and passed as argument
    'name'. As such, this function can only be used inline. 

Arguments
    --name -n    [Required] : Name of associative shell variable. Default: RESULT.

Global Arguments
    --help -h        [Flag] : Show this message and exit.
    --self-test      [Flag] : Runs a self test.

Examples
    Source readmap and load 'key' 'value' into 'map'.
        printf '%s\n' k0 v0 k1 v1 \\
            | ${CLI_COMMAND}
EOF
}

inline() {
    cli::returns::associative_array

    : ${arg_name:=RESULT}

    local key
    local value
    declare -n ref=${arg_name}

    while read -r key; do
        if [[ -z ${key} ]]; then
            cli::fail 'Unexpected empty key.'
        elif ! read -r value; then
            value=
        fi
        ref+=( [$key]="$value" )
    done
}

main() {
    declare -A ${arg_name}
    inline "$@"
    declare -p ${arg_name}
}

self_test() {
    cat /dev/null \
    | ${CLI_COMMAND} --name map \
    | assert::pipe_eq \
        'declare -A map'

    printf '%s\n' k v \
    | ${CLI_COMMAND} \
    | assert::pipe_eq \
        'declare -A RESULT=([k]="v" )'

    printf '%s\n' k0 v0 k1 v1 \
    | ${CLI_COMMAND} \
    | assert::pipe_eq \
        'declare -A RESULT=([k0]="v0" [k1]="v1" )'

    ${CLI_COMMAND} ---emit | source /dev/stdin
    ::cli::util::readmap::inline <<< $'key\nvalue'
    assert::pipe_eq < <(declare -p RESULT) \
        'declare -A RESULT=([key]="value" )'
}

cli::load "$@"